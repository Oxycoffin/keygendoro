<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <!-- Vista responsive -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pomodoro Mejorado</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #00ccff;
            --secondary-color: #66ffff;
            --background-gradient-from: #0d0d0d;
            --background-gradient-to: #121212;
            --button-gradient-angle: 45deg;
            --glare-color: rgba(0, 204, 255, 0.5);
            --cursor-color: rgba(0, 204, 255, 0.7);
            --button-text-color: #ffffff;
            --font-family: 'Press Start 2P', cursive;
            --transition-speed: 0.3s;
        }

        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: var(--font-family);
            transition: all var(--transition-speed) ease;
        }

        body {
            background: radial-gradient(circle at center, var(--background-gradient-from), var(--background-gradient-to)),
                        url('https://www.transparenttextures.com/patterns/dark-mosaic.png');
            background-size: cover;
            background-position: center;
            color: var(--primary-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            position: relative;
            cursor: none;
            animation: backgroundPulse 20s infinite alternate;
        }

        @keyframes backgroundPulse {
            from { background-color: var(--background-gradient-from); }
            to { background-color: var(--background-gradient-to); }
        }

        .pomodoro-container {
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            padding: 1rem;
            width: 90%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            animation: slideIn 1s ease-out;
            box-shadow: 0 0 4px var(--primary-color);
            background-image: url('https://www.transparenttextures.com/patterns/small-dots.png');
            background-size: cover;
            max-height: 95vh;
            position: relative;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fixed-header {
            width: 100%;
            padding: 1rem 0;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .music-control, .focus-toggle, .stats-toggle, .theme-toggle {
            position: absolute;
            top: 20px;
            background: linear-gradient(var(--button-gradient-angle), var(--primary-color), var(--secondary-color));
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background 0.5s, transform 0.3s, box-shadow 0.5s;
            box-shadow: 0 0 2px var(--primary-color), 0 0 5px var(--primary-color);
        }

        .music-control:hover, .focus-toggle:hover, .stats-toggle:hover, .theme-toggle:hover {
            background: linear-gradient(var(--button-gradient-angle), var(--secondary-color), var(--primary-color));
            transform: scale(1.1);
            box-shadow: 0 0 3px var(--secondary-color), 0 0 6px var(--secondary-color);
        }

        .music-control img, .focus-toggle img, .stats-toggle img, .theme-toggle img {
            width: 14px;
            height: 14px;
            filter: brightness(0) invert(1);
            transition: transform 0.3s;
        }

        .music-control { right: 20px; }
        .focus-toggle { right: 60px; }
        .stats-toggle { right: 100px; }
        .theme-toggle { right: 140px; }

        .scrollable-content {
            width: 100%;
            overflow-y: auto;
            flex: 1;
            padding: 0.5rem;
            background: rgba(0, 0, 0, 0.85);
        }

        .header, h2, .timer-display, .session-counter, .task-section h3, .footer, .session-indicator {
            text-align: center;
            color: var(--primary-color);
            text-shadow: 0 0 2px var(--glare-color), 0 0 5px var(--glare-color);
            animation: glowText 2s infinite alternate;
        }

        @keyframes glowText {
            from { text-shadow: 0 0 2px var(--glare-color), 0 0 5px var(--glare-color); }
            to { text-shadow: 0 0 5px var(--secondary-color), 0 0 10px var(--secondary-color); }
        }

        h2 {
            font-size: 1.2rem;
            margin: 0.6rem 0;
            color: var(--secondary-color);
            animation: flicker 3s infinite;
        }

        @keyframes flicker {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .timer-display {
            font-size: 2rem;
            margin-top: 1rem;
            color: var(--secondary-color);
            animation: flicker 3s infinite;
        }

        .session-indicator {
            font-size: 1rem;
            margin-top: 0.5rem;
            color: var(--secondary-color);
        }

        .progress-container {
            width: 100%;
            height: 1.5rem;
            background: rgba(51, 51, 51, 0.7);
            border-radius: 6px;
            overflow: hidden;
            margin-top: 0.8rem;
            box-shadow: inset 0 0 4px var(--primary-color);
            position: relative;
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            transition: width 0.3s;
            z-index: 1;
        }

        .progress-percentage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.8rem;
            color: #ffffff;
            text-shadow: 0.5px 0.5px 1px #000;
            z-index: 2;
        }

        .session-counter, .footer {
            font-size: 0.8rem;
            color: var(--secondary-color);
            margin-top: 1rem;
        }

        .footer {
            color: #666666;
        }

        .task-section h3 {
            font-size: 0.8rem;
            margin-bottom: 0.2rem;
        }

        .task-list {
            list-style: none;
            width: 100%;
            background: #1e1e1e;
            border: 1px solid var(--primary-color);
            border-radius: 4px;
            padding: 0.5rem;
            box-shadow: inset 0 0 4px var(--primary-color);
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .task-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            border-bottom: 1px solid #333;
            color: #ffffff;
            font-size: 0.8rem;
        }

        .task-list li:last-child {
            border-bottom: none;
        }

        .task-list li.completed {
            text-decoration: line-through;
            text-decoration-thickness: 2px;
            color: var(--secondary-color);
        }

        .task-list button {
            background: none;
            border: none;
            color: var(--button-text-color);
            cursor: pointer;
            font-size: 0.8rem;
            margin-left: 0.5rem;
        }

        .task-list button:hover {
            color: var(--secondary-color);
        }

        #customCursor {
            position: fixed;
            top: 0;
            left: 0;
            width: 12px;
            height: 12px;
            background-color: var(--cursor-color);
            border: 2px solid var(--primary-color);
            border-radius: 50%;
            pointer-events: none;
            transform: translate(-50%, -50%);
            animation: pulse 2s infinite;
            z-index: 1000;
            transition: transform 0.2s, background-color 0.5s, border-color 0.5s;
        }

        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(1.3); opacity: 0.6; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        select, input[type="number"], .add-task input {
            width: 100%;
            padding: 0.5rem;
            margin-bottom: 0.8rem;
            border: 2px solid var(--primary-color);
            border-radius: 4px;
            background: #1e1e1e;
            color: #ffffff;
            font-size: 0.8rem;
            appearance: none;
            cursor: pointer;
        }

        .controls {
            display: flex;
            gap: 0.6rem;
            margin-top: 0.8rem;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
        }

        button.control-btn, .add-task button {
            padding: 0.5rem 1rem;
            background: linear-gradient(var(--button-gradient-angle), var(--primary-color), var(--secondary-color));
            border: none;
            border-radius: 4px;
            color: var(--button-text-color);
            font-size: 0.8rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.5s, background 0.5s;
            box-shadow: 0 0 2px var(--primary-color), 0 0 5px var(--primary-color);
            position: relative;
            overflow: hidden;
        }

        button.control-btn:hover, .add-task button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 3px var(--secondary-color), 0 0 6px var(--secondary-color);
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            margin-top: 0.5rem;
        }

        .auto-start-checkbox {
            position: absolute;
            opacity: 0;
            cursor: pointer;
        }

        .checkbox-container label {
            position: relative;
            padding-left: 25px;
            font-size: 0.8rem;
            color: var(--primary-color);
        }

        .checkbox-container label::before {
            content: "";
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            height: 18px;
            width: 18px;
            background-color: #1e1e1e;
            border: 2px solid var(--primary-color);
            border-radius: 4px;
            transition: background-color 0.3s, border-color 0.3s;
        }

        .auto-start-checkbox:checked + label::before {
            background-color: var(--primary-color);
            border-color: var(--secondary-color);
        }

        .checkbox-container label::after {
            content: "";
            position: absolute;
            left: 5px;
            top: 50%;
            transform: translateY(-50%) rotate(45deg);
            width: 5px;
            height: 10px;
            border: solid #ffffff;
            border-width: 0 2px 2px 0;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .auto-start-checkbox:checked + label::after {
            opacity: 1;
        }

        .add-task {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .duration-input, .audio-input, .theme-selector {
            display: flex;
            flex-direction: column;
            margin-bottom: 0.8rem;
        }

        .stats-modal, .quote-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #000000dd;
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            padding: 1rem;
            z-index: 2000;
            max-width: 300px;
            display: none;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .stats-modal.active, .quote-modal.active {
            display: flex;
        }

        .stats-modal h3, .quote-modal h3 {
            font-size: 1rem;
            color: var(--secondary-color);
            margin-bottom: 0.5rem;
        }

        .stats-modal p, .quote-modal p {
            font-size: 0.8rem;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .stats-modal button, .quote-modal button {
            margin-top: 1rem;
        }

        /* Ocultar elementos en modo foco */
        .focus-mode .scrollable-content {
            display: none;
        }

        .focus-mode .dropdown, .focus-mode .task-section {
            display: none;
        }

    </style>
</head>
<body>
<div id="customCursor"></div>
<div class="pomodoro-container" id="pomodoroContainer">
    <!-- Controles Superiores -->
    <div class="music-control interactive" id="musicControl" title="Toggle Música"></div>
    <div class="focus-toggle interactive" id="focusToggle" title="Modo Enfoque"></div>
    <div class="stats-toggle interactive" id="statsToggle" title="Ver Estadísticas"></div>
    <div class="theme-toggle interactive" id="themeToggle" title="Cambiar Tema"></div>

    <!-- Sección Fija -->
    <div class="fixed-header">
        <div class="header">
<pre style="font-family: 'Courier New', monospace; white-space: pre; line-height: 1; font-size: 10px;">
██████╗  ██████╗ ███╗   ███╗ ██████╗ ██████╗  ██████╗ ██████╗  ██████╗
██╔══██╗██╔═══██╗████╗ ████║██╔═══██╗██╔══██╗██╔═══██╗██╔══██╗██╔═══██╗
██████╔╝██║   ██║██╔████╔██║██║   ██║██║  ██║██║   ██║██████╔╝██║   ██║
██╔═══╝ ██║   ██║██║╚██╔╝██║██║   ██║██║  ██║██║   ██║██╔══██╗██║   ██║
██║     ╚██████╔╝██║ ╚═╝ ██║╚██████╔╝██████╔╝╚██████╔╝██║  ██║╚██████╔╝
╚═╝      ╚═════╝ ╚═╝     ╚═╝ ╚═════╝ ╚═════╝  ╚═════╝ ╚═╝  ╚═╝ ╚═════╝
</pre>
        </div>

        <div class="timer-display" id="timerDisplay">25:00</div>
        <div class="session-indicator" id="sessionIndicator">Tipo de Sesión: Trabajo</div>

        <div class="progress-container" id="progressContainer">
            <div class="progress-bar" id="progressBar"></div>
            <div class="progress-percentage" id="progressPercentage">0%</div>
        </div>

        <div class="session-counter" id="sessionCounter">Sesiones completadas: 0</div>

        <div class="controls">
            <button class="control-btn interactive" id="startPauseBtn">Iniciar</button>
            <button class="control-btn interactive" id="skipBtn">Saltar</button>
            <button class="control-btn interactive" id="resetBtn">Reiniciar</button>
        </div>

        <div class="checkbox-container">
            <input type="checkbox" id="autoStartCheckbox" class="auto-start-checkbox">
            <label for="autoStartCheckbox">Auto Iniciar Siguiente Sesión</label>
        </div>
    </div>

    <!-- Sección Desplazable -->
    <div class="scrollable-content">
        <!-- Dropdown para Personalizar Duraciones y Audio -->
        <div class="dropdown">
            <button id="toggleDurationsBtn">Personalizar Opciones</button>
            <div class="dropdown-content" id="dropdownContent">
                <div class="task-section">
                    <!-- Duraciones -->
                    <div class="duration-input">
                        <label for="workDuration">Trabajo (min):</label>
                        <input type="number" id="workDuration" min="1" value="25" class="interactive">
                    </div>
                    <div class="duration-input">
                        <label for="shortBreakDuration">Descanso Corto (min):</label>
                        <input type="number" id="shortBreakDuration" min="1" value="5" class="interactive">
                    </div>
                    <div class="duration-input">
                        <label for="longBreakDuration">Descanso Largo (min):</label>
                        <input type="number" id="longBreakDuration" min="1" value="15" class="interactive">
                    </div>
                    <div class="duration-input">
                        <label for="shortBreaksBeforeLongBreak"># Descansos Cortos Antes Largo:</label>
                        <input type="number" id="shortBreaksBeforeLongBreak" min="1" value="4" class="interactive">
                    </div>

                    <!-- Selección de Sonidos -->
                    <div class="audio-input">
                        <label for="notificationSoundSelect">Sonido de Notificación:</label>
                        <select id="notificationSoundSelect" class="interactive">
                            <option value="notification.mp3">Clásico</option>
                            <option value="bell.mp3">Campana</option>
                            <option value="chime.mp3">Tono Suave</option>
                        </select>
                    </div>

                    <div class="audio-input">
                        <label for="musicTrackSelect">Música de Fondo (Trabajo):</label>
                        <select id="musicTrackSelect" class="interactive">
                            <option value="midi.mp3">MIDI Retro</option>
                            <option value="lofi.mp3">Lo-Fi</option>
                            <option value="nature.mp3">Sonidos de Naturaleza</option>
                        </select>
                    </div>

                    <!-- Selección de Tema Manual -->
                    <div class="theme-selector">
                        <label for="manualThemeSelect">Tema:</label>
                        <select id="manualThemeSelect" class="interactive">
                            <option value="">Aleatorio</option>
                            <option value="azul">Azul Neon</option>
                            <option value="rosa">Rosa Ciber</option>
                            <option value="verde">Verde Tech</option>
                            <option value="amarillo">Amarillo Disco</option>
                            <option value="morado">Morado Retro</option>
                        </select>
                    </div>

                    <button class="control-btn interactive" id="saveDurationsBtn">Guardar</button>
                </div>
            </div>
        </div>

        <!-- Lista de Tareas -->
        <div class="task-section">
            <h3>Lista de Tareas:</h3>
            <ul class="task-list interactive" id="taskList"></ul>
            <div class="add-task">
                <input type="text" id="newTaskInput" placeholder="Nueva tarea..." class="interactive">
                <button class="control-btn interactive" id="addTaskBtn">Añadir</button>
            </div>
        </div>

        <!-- Pie de Página -->
        <div class="footer">2000© no rights reserved - Con mejoras</div>
    </div>
</div>

<!-- Modales -->
<div class="stats-modal" id="statsModal">
    <h3>Estadísticas</h3>
    <p id="todaySessionsCount"></p>
    <p id="weekSessionsCount"></p>
    <button class="control-btn" id="closeStatsBtn">Cerrar</button>
</div>

<div class="quote-modal" id="quoteModal">
    <h3>¡Bien Hecho!</h3>
    <p id="quoteText"></p>
    <button class="control-btn" id="closeQuoteBtn">Cerrar</button>
</div>

<!-- Audios -->
<!-- El src se actualiza dinámicamente -->
<audio id="backgroundMusic" loop></audio>
<audio id="notificationSound"></audio>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Elementos
    const el = {
        startPauseBtn: document.getElementById('startPauseBtn'),
        resetBtn: document.getElementById('resetBtn'),
        skipBtn: document.getElementById('skipBtn'),
        sessionIndicator: document.getElementById('sessionIndicator'),
        progressBar: document.getElementById('progressBar'),
        progressPercentage: document.getElementById('progressPercentage'),
        timerDisplay: document.getElementById('timerDisplay'),
        musicControl: document.getElementById('musicControl'),
        backgroundMusic: document.getElementById('backgroundMusic'),
        notificationSound: document.getElementById('notificationSound'),
        sessionCounter: document.getElementById('sessionCounter'),
        customCursor: document.getElementById('customCursor'),
        saveDurationsBtn: document.getElementById('saveDurationsBtn'),
        workDurationInput: document.getElementById('workDuration'),
        shortBreakDurationInput: document.getElementById('shortBreakDuration'),
        longBreakDurationInput: document.getElementById('longBreakDuration'),
        shortBreaksBeforeLongBreakInput: document.getElementById('shortBreaksBeforeLongBreak'),
        taskList: document.getElementById('taskList'),
        addTaskBtn: document.getElementById('addTaskBtn'),
        newTaskInput: document.getElementById('newTaskInput'),
        toggleDurationsBtn: document.getElementById('toggleDurationsBtn'),
        dropdownContent: document.getElementById('dropdownContent'),
        autoStartCheckbox: document.getElementById('autoStartCheckbox'),
        focusToggle: document.getElementById('focusToggle'),
        statsToggle: document.getElementById('statsToggle'),
        themeToggle: document.getElementById('themeToggle'),
        pomodoroContainer: document.getElementById('pomodoroContainer'),
        statsModal: document.getElementById('statsModal'),
        closeStatsBtn: document.getElementById('closeStatsBtn'),
        todaySessionsCount: document.getElementById('todaySessionsCount'),
        weekSessionsCount: document.getElementById('weekSessionsCount'),
        quoteModal: document.getElementById('quoteModal'),
        closeQuoteBtn: document.getElementById('closeQuoteBtn'),
        quoteText: document.getElementById('quoteText'),
        notificationSoundSelect: document.getElementById('notificationSoundSelect'),
        musicTrackSelect: document.getElementById('musicTrackSelect'),
        manualThemeSelect: document.getElementById('manualThemeSelect')
    };

    // Estado
    let isMusicMuted = false;
    let timerDuration = 25 * 60;
    let timerRemaining = timerDuration;
    let timerInterval = null;
    let isRunning = false;
    let currentSession = 'work';
    let completedWorkSessions = 0;
    let endTime = null;
    let shortBreaksBeforeLongBreak = getFromStorage('shortBreaksBeforeLongBreak', 4);
    let shortBreaksCompleted = 0;
    let currentManualTheme = getFromStorage('manualTheme', '');

    const colorPalettes = {
        "": [
            { primary: '#00ccff', secondary: '#66ffff', gradientFrom: '#0d0d0d', gradientTo: '#121212', gradientAngle: '45deg', cursorColor: 'rgba(0, 204, 255, 0.7)' },
            { primary: '#ff66cc', secondary: '#ff99ee', gradientFrom: '#1a0d0d', gradientTo: '#2c1212', gradientAngle: '60deg', cursorColor: 'rgba(255, 102, 204, 0.7)' },
            { primary: '#66ff66', secondary: '#99ff99', gradientFrom: '#0d1a0d', gradientTo: '#121c12', gradientAngle: '30deg', cursorColor: 'rgba(102, 255, 102, 0.7)' },
            { primary: '#ffcc00', secondary: '#ffe066', gradientFrom: '#1a1a0d', gradientTo: '#2c2c12', gradientAngle: '90deg', cursorColor: 'rgba(255, 204, 0, 0.7)' },
            { primary: '#cc00ff', secondary: '#e066ff', gradientFrom: '#0d0d1a', gradientTo: '#12122c', gradientAngle: '135deg', cursorColor: 'rgba(204, 0, 255, 0.7)' }
        ],
        "azul": [{ primary: '#00ccff', secondary: '#66ffff', gradientFrom: '#0d0d0d', gradientTo: '#121212', gradientAngle: '45deg', cursorColor: 'rgba(0, 204, 255, 0.7)' }],
        "rosa": [{ primary: '#ff66cc', secondary: '#ff99ee', gradientFrom: '#1a0d0d', gradientTo: '#2c1212', gradientAngle: '60deg', cursorColor: 'rgba(255, 102, 204, 0.7)' }],
        "verde": [{ primary: '#66ff66', secondary: '#99ff99', gradientFrom: '#0d1a0d', gradientTo: '#121c12', gradientAngle: '30deg', cursorColor: 'rgba(102, 255, 102, 0.7)' }],
        "amarillo": [{ primary: '#ffcc00', secondary: '#ffe066', gradientFrom: '#1a1a0d', gradientTo: '#2c2c12', gradientAngle: '90deg', cursorColor: 'rgba(255, 204, 0, 0.7)' }],
        "morado": [{ primary: '#cc00ff', secondary: '#e066ff', gradientFrom: '#0d0d1a', gradientTo: '#12122c', gradientAngle: '135deg', cursorColor: 'rgba(204, 0, 255, 0.7)' }]
    };

    const motivationalQuotes = [
        "Sigue así, tu esfuerzo dará frutos.",
        "Cada minuto cuenta, ¡aprovéchalo!",
        "La perseverancia es la clave del éxito.",
        "¡Grandioso trabajo! Un paso más cerca de tu meta.",
        "Tu dedicación marca la diferencia.",
        "La constancia vence a la resistencia."
    ];

    // Funciones Auxiliares
    function getFromStorage(key, defaultValue) {
        const val = localStorage.getItem(key);
        return val !== null ? JSON.parse(val) : defaultValue;
    }

    function saveToStorage(key, value) {
        localStorage.setItem(key, JSON.stringify(value));
    }

    function capitalizeFirstLetter(str) {
        return str.charAt(0).toUpperCase() + str.slice(1);
    }

    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }

    function selectRandomPalette(themeKey = "") {
        const palettes = colorPalettes[themeKey] || colorPalettes[""];
        return palettes[Math.floor(Math.random() * palettes.length)];
    }

    function getDurationBySession(session) {
        const work = parseInt(el.workDurationInput.value, 10);
        const shortB = parseInt(el.shortBreakDurationInput.value, 10);
        const longB = parseInt(el.longBreakDurationInput.value, 10);

        const durations = {
            work: work,
            shortBreak: shortB,
            longBreak: longB
        };
        return (durations[session] || 25) * 60;
    }

    function updateTimerDisplay(secondsRemaining) {
        el.timerDisplay.textContent = formatTime(secondsRemaining);
    }

    function updateProgressBar(percentage) {
        el.progressBar.style.width = `${percentage}%`;
        el.progressPercentage.textContent = `${Math.floor(percentage)}%`;
    }

    function notifyUser(message) {
        if ('Notification' in window) {
            if (Notification.permission === 'granted') {
                new Notification(message);
            } else if (Notification.permission !== 'denied') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') new Notification(message);
                });
            }
        }
    }

    function saveTimerState() {
        saveToStorage('timerState', {
            endTime,
            currentSession,
            completedWorkSessions,
            shortBreaksCompleted
        });
    }

    function clearTimerState() {
        localStorage.removeItem('timerState');
        endTime = null;
    }

    function updateSessionType() {
        timerDuration = getDurationBySession(currentSession);
        timerRemaining = timerDuration;
        updateTimerDisplay(timerRemaining);
        updateProgressBar(0);
        el.sessionIndicator.textContent = `Tipo de Sesión: ${capitalizeFirstLetter(currentSession)}`;
        resetMusic();
        clearTimerState();
    }

    function startTimer(shouldSave = true) {
        if (isRunning) return;
        isRunning = true;
        el.startPauseBtn.textContent = 'Pausar';

        if (shouldSave) {
            endTime = Date.now() + timerRemaining * 1000;
            saveTimerState();
        }

        timerInterval = setInterval(() => {
            const now = Date.now();
            timerRemaining = Math.floor((endTime - now) / 1000);

            if (timerRemaining > 0) {
                updateTimerDisplay(timerRemaining);
                const progress = ((getDurationBySession(currentSession) - timerRemaining) / getDurationBySession(currentSession)) * 100;
                updateProgressBar(progress);
            } else {
                stopTimer();
                updateTimerDisplay(0);
                updateProgressBar(100);
                handleSessionEnd();
            }
        }, 1000);

        if (currentSession === 'work') playMusic();
    }

    function pauseTimer() {
        if (!isRunning) return;
        isRunning = false;
        el.startPauseBtn.textContent = 'Iniciar';
        clearInterval(timerInterval);
        if (currentSession === 'work') pauseMusic();
        clearTimerState();
        changePalette();
    }

    function stopTimer() {
        clearInterval(timerInterval);
        isRunning = false;
        el.startPauseBtn.textContent = 'Iniciar';
        if (currentSession === 'work') pauseMusic();
        clearTimerState();
    }

    function resetTimer() {
        stopTimer();
        timerRemaining = getDurationBySession(currentSession);
        updateTimerDisplay(timerRemaining);
        updateProgressBar(0);
        changePalette();
    }

    function skipSession() {
        if (isRunning) {
            stopTimer();
        }
        handleSessionEnd(false);
        changePalette();
    }

    function handleSessionEnd(shouldAutoStart = true) {
        if (currentSession === 'work') {
            completedWorkSessions++;
            el.sessionCounter.textContent = `Sesiones completadas: ${completedWorkSessions}`;
            saveToStorage('completedWorkSessions', completedWorkSessions);
            logSessionCompletion(); // Guarda la sesión en estadísticas
            showMotivationalQuote();
        }
        el.notificationSound.play();
        notifyUser(`¡${capitalizeFirstLetter(currentSession)} finalizada!`);

        if (currentSession === 'work') {
            currentSession = 'shortBreak';
        } else if (currentSession === 'shortBreak') {
            shortBreaksCompleted++;
            if (shortBreaksCompleted >= shortBreaksBeforeLongBreak) {
                currentSession = 'longBreak';
                shortBreaksCompleted = 0;
            } else {
                currentSession = 'work';
            }
        } else {
            currentSession = 'work';
        }

        updateSessionType();

        if (shouldAutoStart && el.autoStartCheckbox.checked) {
            startTimer();
            changePalette();
        }
    }

    function changePalette() {
        let palette;
        if (currentManualTheme && colorPalettes[currentManualTheme]) {
            // Tema manual
            palette = selectRandomPalette(currentManualTheme);
        } else {
            // Tema aleatorio
            palette = selectRandomPalette("");
        }

        const root = document.documentElement;
        root.style.setProperty('--primary-color', palette.primary);
        root.style.setProperty('--secondary-color', palette.secondary);
        root.style.setProperty('--background-gradient-from', palette.gradientFrom);
        root.style.setProperty('--background-gradient-to', palette.gradientTo);
        root.style.setProperty('--button-gradient-angle', palette.gradientAngle);
        root.style.setProperty('--cursor-color', palette.cursorColor);

        el.customCursor.style.backgroundColor = palette.cursorColor;
        el.customCursor.style.borderColor = palette.primary;
    }

    // Tareas
    function addTask(task = {}) {
        const taskName = task.name || el.newTaskInput.value.trim();
        if (!taskName) {
            alert('Por favor, introduce una tarea.');
            return;
        }

        const li = document.createElement('li');
        li.textContent = taskName;
        li.dataset.id = task.id || Date.now();
        if (task.completed) li.classList.add('completed');

        const completeBtn = document.createElement('button');
        completeBtn.textContent = 'DONE';
        completeBtn.title = 'Marcar como completado';
        completeBtn.classList.add('complete-btn');

        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'ERASE';
        deleteBtn.title = 'Eliminar tarea';
        deleteBtn.classList.add('delete-btn');

        li.appendChild(completeBtn);
        li.appendChild(deleteBtn);
        el.taskList.appendChild(li);

        if (!task.id) {
            saveTask({ id: li.dataset.id, name: taskName, completed: false });
            el.newTaskInput.value = '';
        }
    }

    function saveTask(task) {
        const tasks = getFromStorage('tasks', []);
        tasks.push(task);
        saveToStorage('tasks', tasks);
    }

    function saveAllTasks() {
        const tasks = Array.from(el.taskList.children).map(li => ({
            id: li.dataset.id,
            name: li.firstChild.textContent.trim(),
            completed: li.classList.contains('completed')
        }));
        saveToStorage('tasks', tasks);
    }

    function deleteTask(id) {
        let tasks = getFromStorage('tasks', []);
        tasks = tasks.filter(task => task.id !== id);
        saveToStorage('tasks', tasks);
    }

    // Música y Sonidos
    function playMusic() {
        if (!isMusicMuted && currentSession === 'work') {
            el.backgroundMusic.play().catch(() => {
                console.log('No se pudo reproducir la música.');
            });
        }
    }

    function pauseMusic() {
        el.backgroundMusic.pause();
    }

    function resetMusic() {
        el.backgroundMusic.pause();
        el.backgroundMusic.currentTime = 0;
    }

    function toggleMusic() {
        isMusicMuted = !isMusicMuted;
        saveToStorage('isMusicMuted', isMusicMuted);
        updateMusicIcon();
        if (currentSession === 'work') {
            if (isMusicMuted) {
                pauseMusic();
            } else {
                playMusic();
            }
        }
        changePalette();
    }

    function updateMusicIcon() {
        el.musicControl.innerHTML = '';
        const img = document.createElement('img');
        img.src = isMusicMuted
            ? "https://img.icons8.com/ios-filled/50/ffffff/mute.png"
            : "https://img.icons8.com/ios-filled/50/ffffff/speaker.png";
        el.musicControl.appendChild(img);
    }

    // Estadísticas
    function logSessionCompletion() {
        // Guardar timestamp de la sesión completada
        const sessionsLog = getFromStorage('sessionsLog', []);
        sessionsLog.push(Date.now());
        saveToStorage('sessionsLog', sessionsLog);
    }

    function showStats() {
        const sessionsLog = getFromStorage('sessionsLog', []);
        const now = new Date();
        const today = sessionsLog.filter(s => {
            const d = new Date(s);
            return d.toDateString() === now.toDateString();
        }).length;
        el.todaySessionsCount.textContent = `Sesiones Hoy: ${today}`;

        const weekStart = new Date(now);
        weekStart.setDate(now.getDate() - now.getDay()); // Lunes
        const thisWeek = sessionsLog.filter(s => {
            const d = new Date(s);
            return d >= weekStart && d <= now;
        }).length;
        el.weekSessionsCount.textContent = `Sesiones Esta Semana: ${thisWeek}`;

        el.statsModal.classList.add('active');
    }

    function showMotivationalQuote() {
        const quote = motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)];
        el.quoteText.textContent = quote;
        el.quoteModal.classList.add('active');
    }

    // Cargar Datos
    function loadData() {
        completedWorkSessions = getFromStorage('completedWorkSessions', 0);
        el.sessionCounter.textContent = `Sesiones completadas: ${completedWorkSessions}`;

        const tasks = getFromStorage('tasks', []);
        tasks.forEach(addTask);

        const work = getFromStorage('workDuration', 25);
        const shortB = getFromStorage('shortBreakDuration', 5);
        const longB = getFromStorage('longBreakDuration', 15);
        const sBeforeL = getFromStorage('shortBreaksBeforeLongBreak', 4);

        el.workDurationInput.value = work;
        el.shortBreakDurationInput.value = shortB;
        el.longBreakDurationInput.value = longB;
        el.shortBreaksBeforeLongBreakInput.value = sBeforeL;
        shortBreaksBeforeLongBreak = sBeforeL;

        const nSound = getFromStorage('notificationSoundFile', 'notification.mp3');
        const mTrack = getFromStorage('musicTrackFile', 'midi.mp3');
        el.notificationSoundSelect.value = nSound;
        el.musicTrackSelect.value = mTrack;
        el.notificationSound.src = nSound;
        el.backgroundMusic.src = mTrack;

        const isAuto = getFromStorage('isAutoStartEnabled', false);
        el.autoStartCheckbox.checked = isAuto;

        isMusicMuted = getFromStorage('isMusicMuted', false);
        el.backgroundMusic.muted = isMusicMuted;
        updateMusicIcon();

        changePalette();

        const timerState = getFromStorage('timerState', null);
        if (timerState) {
            endTime = timerState.endTime;
            currentSession = timerState.currentSession;
            completedWorkSessions = timerState.completedWorkSessions || 0;
            shortBreaksCompleted = timerState.shortBreaksCompleted || 0;
            el.sessionIndicator.textContent = `Tipo de Sesión: ${capitalizeFirstLetter(currentSession)}`;
            timerDuration = getDurationBySession(currentSession);
            const now = Date.now();
            timerRemaining = Math.floor((endTime - now) / 1000);

            if (timerRemaining > 0) {
                updateTimerDisplay(timerRemaining);
                const progress = ((getDurationBySession(currentSession) - timerRemaining) / getDurationBySession(currentSession)) * 100;
                updateProgressBar(progress);
                startTimer(false);
            } else {
                handleSessionEnd();
            }
        }

        if ('Notification' in window && Notification.permission !== 'granted' && Notification.permission !== 'denied') {
            Notification.requestPermission();
        }
    }

    // Eventos
    el.startPauseBtn.addEventListener('click', () => {
        isRunning ? pauseTimer() : startTimer();
        changePalette();
    });

    el.resetBtn.addEventListener('click', resetTimer);
    el.skipBtn.addEventListener('click', skipSession);

    el.saveDurationsBtn.addEventListener('click', () => {
        const work = parseInt(el.workDurationInput.value, 10);
        const shortB = parseInt(el.shortBreakDurationInput.value, 10);
        const longB = parseInt(el.longBreakDurationInput.value, 10);
        const sBeforeL = parseInt(el.shortBreaksBeforeLongBreakInput.value, 10);
        const nSound = el.notificationSoundSelect.value;
        const mTrack = el.musicTrackSelect.value;
        const mTheme = el.manualThemeSelect.value;

        if ([work, shortB, longB, sBeforeL].some(d => isNaN(d) || d < 1)) {
            alert('Por favor, introduce duraciones válidas');
            return;
        }

        saveToStorage('workDuration', work);
        saveToStorage('shortBreakDuration', shortB);
        saveToStorage('longBreakDuration', longB);
        saveToStorage('shortBreaksBeforeLongBreak', sBeforeL);
        saveToStorage('notificationSoundFile', nSound);
        saveToStorage('musicTrackFile', mTrack);
        saveToStorage('manualTheme', mTheme);

        shortBreaksBeforeLongBreak = sBeforeL;
        el.notificationSound.src = nSound;
        el.backgroundMusic.src = mTrack;
        currentManualTheme = mTheme;

        alert('Opciones guardadas exitosamente.');
        updateSessionType();
        changePalette();
    });

    el.addTaskBtn.addEventListener('click', () => {
        addTask();
        changePalette();
        saveAllTasks();
    });

    el.newTaskInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            addTask();
            changePalette();
            saveAllTasks();
        }
    });

    el.taskList.addEventListener('click', (e) => {
        const li = e.target.closest('li');
        if (!li) return;
        const id = li.dataset.id;

        if (e.target.classList.contains('complete-btn')) {
            li.classList.toggle('completed');
            saveAllTasks();
        }

        if (e.target.classList.contains('delete-btn')) {
            li.remove();
            deleteTask(id);
        }
    });

    el.musicControl.addEventListener('click', toggleMusic);

    document.addEventListener('mousemove', (e) => {
        el.customCursor.style.left = `${e.clientX}px`;
        el.customCursor.style.top = `${e.clientY}px`;
    });

    document.querySelectorAll('.interactive').forEach(elem => {
        elem.addEventListener('mouseenter', () => {
            el.customCursor.style.transform = 'translate(-50%, -50%) scale(1.5)';
            el.customCursor.style.backgroundColor = '#ff6600';
            el.customCursor.style.borderColor = '#ff6600';
        });

        elem.addEventListener('mouseleave', () => {
            el.customCursor.style.transform = 'translate(-50%, -50%) scale(1)';
            el.customCursor.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--cursor-color');
            el.customCursor.style.borderColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-color');
        });
    });

    el.autoStartCheckbox.addEventListener('change', () => {
        saveToStorage('isAutoStartEnabled', el.autoStartCheckbox.checked);
    });

    el.toggleDurationsBtn.addEventListener('click', () => {
        el.dropdownContent.classList.toggle('open');
        el.toggleDurationsBtn.classList.toggle('active');
    });

    el.focusToggle.addEventListener('click', () => {
        el.pomodoroContainer.classList.toggle('focus-mode');
    });

    el.statsToggle.addEventListener('click', showStats);
    el.closeStatsBtn.addEventListener('click', () => el.statsModal.classList.remove('active'));

    el.closeQuoteBtn.addEventListener('click', () => el.quoteModal.classList.remove('active'));

    el.themeToggle.addEventListener('click', () => {
        // Si hay tema manual, lo quita, si no, vuelve a aleatorio
        if (currentManualTheme) {
            currentManualTheme = "";
        } else {
            // Cicla a un siguiente tema manual por demo
            // En la realidad, podría abrir un menú, pero acá simplemente
            // alternamos entre algunos temas manualmente.
            const themes = ["azul", "rosa", "verde", "amarillo", "morado"];
            currentManualTheme = themes[Math.floor(Math.random() * themes.length)];
        }
        saveToStorage('manualTheme', currentManualTheme);
        changePalette();
    });

    // Cargar Data Inicial
    loadData();
});
</script>
</body>
</html>
